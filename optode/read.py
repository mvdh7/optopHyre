import pandas as pd
import os
import numpy as np


def read_pyrosci(datasheet_filepath, txt_filepath):
    """Import the text files generated by PyroScience Workbench as a
    pandas DataFrame."""
    db = pd.read_excel(datasheet_filepath, skiprows=[1])
    file_list = [
        file
        for file in os.listdir(txt_filepath)
        if "_".join(file.split("_")) in db.pH_optN.values
    ]
    data_dict = {}
    for file in file_list:
        fname = "./data/underway/pH/{}/{}.txt".format(file, file)
        print(fname)
        data_dict[file] = pd.read_table(fname, skiprows=22, encoding="unicode_escape")
    rn = {
        "Date [A Ch.1 Main]": "date",
        "Time [A Ch.1 Main]": "time",
        " dt (s) [A Ch.1 Main]": "sec",
        "pH [A Ch.1 Main]": "pH_cell",
        "Sample Temp. (°C) [A Ch.1 CompT]": "temp_cell",
        "dphi (°) [A Ch.1 Main]": "dphi",
        "Signal Intensity (mV) [A Ch.1 Main]": "signal_intensity",
        "Ambient Light (mV) [A Ch.1 Main]": "ambient_light",
        "ldev (nm) [A Ch.1 Main]": "ldev",
        "Status [A Ch.1 Main]": "status_ph",
        "Status [A Ch.1 CompT]": "status_temp",
    }
    for file in file_list:
        data_dict[file] = data_dict[file].rename(rn, axis=1)
        data_dict[file]["filename"] = np.nan
        data_dict[file].filename = file
        data_dict[file]["date_time"] = np.nan
        data_dict[file].date_time = data_dict[file].date + " " + data_dict[file].time
        data_dict[file].date_time = pd.to_datetime(
            data_dict[file].date_time, format="%d-%m-%Y %H:%M:%S.%f"
        )

        data_dict[file].dropna()
        print(file)
        data_dict[file] = data_dict[file][
            [
                "filename",
                "date_time",
                "sec",
                "pH_cell",
                "temp_cell",
                "dphi",
                "signal_intensity",
                "ambient_light",
                "ldev",
                "status_ph",
                "status_temp",
            ]
        ]
    return data_dict, file_list
